# 实现计划：批量删除用户功能

## 概述

本实现计划将批量删除功能集成到现有的用户管理系统中。实现将遵循现有的架构模式，使用 Vue 3 Composition API、Pinia 状态管理和 Ant Design Vue 组件库。任务按照从底层到上层的顺序组织，确保每个步骤都可以独立测试和验证。

## 任务

- [ ] 1. 扩展类型定义和 API 客户端
  - [x] 1.1 在 `src/types/user.ts` 中添加批量删除相关类型定义
    - 添加 `BatchDeleteRequest` 接口
    - 添加 `BatchDeleteResponse` 接口
    - 添加 `RowSelectionConfig` 接口
    - _需求：6.1, 6.2_
  
  - [x] 1.2 在 `src/services/apiClient.ts` 中添加批量删除方法
    - 实现 `batchDeleteUsers(userIds: string[]): Promise<ApiResponse<void>>` 方法
    - 配置请求超时为 5000ms
    - 使用 DELETE 方法，路径为 `/users/batch`
    - 请求体包含 `{ userIds }` 数据
    - _需求：6.1, 6.2, 6.5_
  
  - [ ]* 1.3 编写 API 客户端批量删除方法的单元测试
    - 测试成功场景：验证请求格式和响应处理
    - 测试失败场景：验证错误处理
    - 测试超时配置：验证请求超时设置
    - _需求：6.2, 6.5_
  
  - [ ]* 1.4 编写 API 响应格式一致性的属性测试
    - **属性 12：API 响应格式一致性**
    - **验证需求：6.3**
    - 生成随机用户 ID 数组
    - 验证响应包含 data、message、success、timestamp 字段
    - 最少 100 次迭代

- [ ] 2. 扩展模拟 API 服务
  - [x] 2.1 在 `src/services/mockApiService.ts` 中添加批量删除端点
    - 实现 `DELETE /users/batch` 端点
    - 验证请求体中的 userIds 数组
    - 处理部分用户不存在的情况（返回 404）
    - 执行批量删除并更新内存存储
    - 保存到 localStorage
    - 返回标准 API 响应格式
    - _需求：6.1, 6.2, 6.3_
  
  - [ ]* 2.2 编写模拟 API 批量删除端点的单元测试
    - 测试成功删除场景
    - 测试空数组验证
    - 测试部分用户不存在场景
    - 测试数据持久化
    - _需求：6.1, 6.2, 6.3_
  
  - [ ]* 2.3 编写部分失败错误信息的属性测试
    - **属性 14：部分失败错误信息**
    - **验证需求：5.4**
    - 生成包含存在和不存在用户 ID 的数组
    - 验证错误响应包含失败的用户 ID 列表

- [ ] 3. 扩展 UserStore
  - [x] 3.1 在 `src/stores/userStore.ts` 中添加批量删除方法
    - 实现 `batchDeleteUsers(userIds: string[]): Promise<void>` 方法
    - 验证 userIds 数组不为空
    - 调用 API 客户端的批量删除方法
    - 成功后从本地状态中移除已删除的用户
    - 更新 localStorage
    - 处理错误并设置 error 状态
    - _需求：4.1, 4.3, 5.1_
  
  - [ ]* 3.2 编写 UserStore 批量删除方法的单元测试
    - 测试成功删除场景
    - 测试空数组验证错误
    - 测试 API 调用失败场景
    - 测试本地状态更新
    - _需求：4.1, 4.3, 5.1_
  
  - [ ]* 3.3 编写批量删除移除用户的属性测试
    - **属性 8：批量删除移除用户**
    - **验证需求：4.3, 4.6**
    - 生成随机用户列表和随机选中的用户 ID
    - 执行批量删除
    - 验证被删除的用户不在列表中
    - 最少 100 次迭代

- [ ] 4. 创建 BatchDeleteButton 组件
  - [x] 4.1 创建 `src/components/BatchDeleteButton.vue` 组件
    - 定义 Props：selectedCount、loading、disabled
    - 定义 Emits：click 事件
    - 实现按钮禁用逻辑（selectedCount === 0 或 loading 或 disabled）
    - 实现按钮文本逻辑（显示选中数量）
    - 使用 danger 样式和 DeleteOutlined 图标
    - _需求：2.1, 2.2, 2.3, 2.4_
  
  - [ ]* 4.2 编写 BatchDeleteButton 组件的单元测试
    - 测试按钮在 selectedCount 为 0 时禁用
    - 测试按钮文本显示选中数量
    - 测试按钮点击事件触发
    - 测试 danger 样式应用
    - _需求：2.1, 2.2, 2.3, 2.4_
  
  - [ ]* 4.3 编写批量删除按钮显示逻辑的属性测试
    - **属性 4：批量删除按钮显示逻辑**
    - **验证需求：1.5, 2.1, 2.2**
    - 生成随机选中数量（0 到 100）
    - 验证按钮禁用状态与选中数量的关系
  
  - [ ]* 4.4 编写批量删除按钮文本的属性测试
    - **属性 5：批量删除按钮文本**
    - **验证需求：2.3**
    - 生成随机选中数量（1 到 100）
    - 验证按钮文本包含正确的数量

- [ ] 5. 修改 UserTable 组件以支持行选择
  - [x] 5.1 修改 `src/components/UserTable.vue` 添加行选择功能
    - 添加 Props：selectedRowKeys（可选，默认空数组）
    - 添加 Emits：selectionChange 事件
    - 创建 rowSelection 计算属性配置
    - 在 a-table 组件上添加 :row-selection 属性
    - _需求：1.1, 1.2, 1.3_
  
  - [ ]* 5.2 编写 UserTable 行选择功能的单元测试
    - 测试行选择复选框渲染
    - 测试点击复选框触发 selectionChange 事件
    - 测试 selectedRowKeys prop 正确传递
    - _需求：1.1, 1.2_
  
  - [ ]* 5.3 编写行选择状态切换的属性测试
    - **属性 1：行选择状态切换**
    - **验证需求：1.2**
    - 生成随机用户列表和随机选中的行索引
    - 模拟点击复选框
    - 验证选中状态正确切换
    - 最少 100 次迭代
  
  - [ ]* 5.4 编写全选功能的属性测试
    - **属性 2：全选功能**
    - **验证需求：1.3**
    - 生成随机用户列表
    - 模拟点击全选复选框
    - 验证所有用户被选中或取消选中
    - 最少 100 次迭代

- [ ] 6. 修改 UserManagement 组件以集成批量删除功能
  - [x] 6.1 修改 `src/components/UserManagement.vue` 添加批量删除状态和方法
    - 添加状态：selectedUserIds、isDeleting、showBatchDeleteConfirm
    - 添加计算属性：hasSelectedUsers、selectedCount、selectedUsers
    - 添加方法：handleSelectionChange、showBatchDeleteDialog、handleBatchDelete、cancelBatchDelete
    - 在模板中添加 BatchDeleteButton 组件
    - 在模板中添加确认对话框（a-modal）
    - 传递 selectedRowKeys 到 UserTable
    - 监听 UserTable 的 selectionChange 事件
    - _需求：1.5, 2.2, 3.1, 4.1, 4.5_
  
  - [ ]* 6.2 编写 UserManagement 批量删除功能的单元测试
    - 测试选中状态管理
    - 测试批量删除按钮显示/隐藏
    - 测试确认对话框显示
    - 测试取消操作
    - 测试成功删除流程
    - 测试失败处理
    - _需求：3.1, 3.4, 4.1, 4.4, 5.1_
  
  - [ ]* 6.3 编写确认对话框显示的属性测试
    - **属性 6：确认对话框显示**
    - **验证需求：3.1, 3.2**
    - 生成随机选中用户数量
    - 模拟点击批量删除按钮
    - 验证对话框显示且包含正确的用户数量
  
  - [ ]* 6.4 编写取消操作保持状态的属性测试
    - **属性 7：取消操作保持状态**
    - **验证需求：3.4, 3.5**
    - 生成随机用户列表和选中的用户
    - 显示确认对话框后点击取消
    - 验证用户列表和选中状态未改变
  
  - [ ]* 6.5 编写批量删除清空选中状态的属性测试
    - **属性 9：批量删除清空选中状态**
    - **验证需求：4.5**
    - 生成随机选中的用户 ID
    - 执行批量删除成功
    - 验证 selectedUserIds 数组长度为 0
  
  - [ ]* 6.6 编写批量删除失败保持选中状态的属性测试
    - **属性 10：批量删除失败保持选中状态**
    - **验证需求：5.5**
    - 生成随机选中的用户 ID
    - 模拟批量删除失败
    - 验证 selectedUserIds 保持不变

- [ ] 7. 添加响应式设计支持
  - [x] 7.1 在 UserManagement 组件中添加响应式布局逻辑
    - 使用 Grid.useBreakpoint() 检测屏幕尺寸
    - 在移动设备上调整批量删除按钮位置
    - 在移动设备上调整确认对话框宽度
    - _需求：7.1, 7.2, 7.3_
  
  - [ ]* 7.2 编写响应式设计的单元测试
    - 测试桌面布局
    - 测试移动布局
    - 测试平板布局
    - _需求：7.1, 7.2, 7.3_

- [ ] 8. 集成测试和最终验证
  - [ ]* 8.1 编写完整批量删除流程的集成测试
    - 创建测试用户
    - 选中多个用户
    - 点击批量删除按钮
    - 确认删除
    - 验证用户被删除
    - 验证选中状态被清空
    - _需求：1.1, 1.2, 2.2, 3.1, 4.1, 4.3, 4.5_
  
  - [ ]* 8.2 编写错误处理的集成测试
    - 测试网络错误场景
    - 测试部分用户不存在场景
    - 测试服务器错误场景
    - 验证错误消息显示
    - 验证选中状态保持
    - _需求：5.1, 5.2, 5.3, 5.4, 5.5_
  
  - [ ]* 8.3 编写操作互斥的属性测试
    - **属性 15：操作互斥**
    - **验证需求：8.4**
    - 模拟批量删除操作进行中
    - 验证其他操作按钮被禁用

- [ ] 9. 检查点 - 确保所有测试通过
  - 运行所有单元测试：`npm run test:unit`
  - 运行所有属性测试：`npm run test:prop`
  - 确保代码覆盖率达到 90% 以上
  - 确保所有功能正常工作
  - 如有问题，请向用户报告

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据需要跳过以加快 MVP 开发
- 每个任务都引用了相关的需求编号，便于追溯
- 任务按照从底层到上层的顺序组织，确保依赖关系正确
- 属性测试必须运行至少 100 次迭代
- 所有代码必须遵循项目的编码规范（Vue 3 + TypeScript + Ant Design Vue）
- 所有错误消息必须使用中文
- 所有代码注释必须使用中文
