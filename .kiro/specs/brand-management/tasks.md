# 实施计划：品牌管理

## 概述

本实施计划将品牌管理功能分解为一系列增量式的开发任务。每个任务都建立在前面任务的基础上，确保代码的连续性和可测试性。任务按照从基础设施到核心功能再到用户界面的顺序组织。

## 任务列表

- [x] 1. 创建品牌类型定义和数据模型
  - 在 `src/types/brand.ts` 中定义 Brand、BrandStatus、CreateBrandDto、UpdateBrandDto 等接口
  - 定义 BrandQueryParams、BatchImportResult、ValidationResult 等辅助类型
  - 定义 ParseResult、OperationResult 等通用类型
  - _需求：1.2, 2.2, 2.3, 6.2, 7.7_

- [x] 2. 实现品牌服务层（brandService.ts）
  - [x] 2.1 创建品牌验证服务
    - 实现 validateBrandData 函数，验证品牌名称和编码格式
    - 实现 isBrandCodeUnique 函数，检查编码唯一性
    - 实现 formatBrandData 函数，格式化品牌数据
    - _需求：2.2, 2.3, 2.4, 3.4_

  - [ ]* 2.2 编写品牌验证服务的属性测试
    - **属性 3：品牌名称验证** - 验证需求 2.2
    - **属性 4：品牌编码格式验证** - 验证需求 2.3
    - **属性 5：品牌编码唯一性约束** - 验证需求 2.4
    - 使用 fast-check 生成随机测试数据，最少 100 次迭代

  - [ ]* 2.3 编写品牌验证服务的单元测试
    - 测试空品牌名称验证
    - 测试无效品牌编码格式
    - 测试品牌编码唯一性检查
    - 测试边界情况（最小/最大长度）

- [x] 3. 实现 Excel 服务层（excelService.ts）
  - [x] 3.1 创建 Excel 处理服务
    - 安装 xlsx 依赖：`npm install xlsx`
    - 实现 generateBrandTemplate 函数，生成 Excel 模板
    - 实现 downloadExcelFile 函数，触发文件下载
    - 实现 parseBrandExcel 函数，解析上传的 Excel 文件
    - 实现 validateExcelRow 函数，验证 Excel 行数据
    - _需求：6.1, 6.2, 6.3, 7.4, 7.5_

  - [ ]* 3.2 编写 Excel 服务的属性测试
    - **属性 16：模板格式完整性** - 验证需求 6.1, 6.2, 6.3
    - **属性 17：模板文件命名格式** - 验证需求 6.5
    - **属性 19：Excel 文件解析** - 验证需求 7.4
    - **属性 20：无效数据错误报告** - 验证需求 7.5

  - [ ]* 3.3 编写 Excel 服务的单元测试
    - 测试模板生成包含正确的列标题
    - 测试模板包含示例数据
    - 测试文件命名格式
    - 测试 Excel 解析功能
    - 测试无效数据的错误报告

- [x] 4. 扩展 API 客户端（apiClient.ts）
  - [x] 4.1 添加品牌相关的 API 方法
    - 实现 getBrands 方法（GET /brands）
    - 实现 getBrandById 方法（GET /brands/:id）
    - 实现 createBrand 方法（POST /brands）
    - 实现 updateBrand 方法（PUT /brands/:id）
    - 实现 deleteBrand 方法（DELETE /brands/:id）
    - 实现 batchCreateBrands 方法（POST /brands/batch）
    - _需求：8.1_

  - [ ]* 4.2 编写 API 客户端的单元测试
    - 使用 axios-mock-adapter 模拟 HTTP 请求
    - 测试所有 CRUD 操作的 API 调用
    - 测试批量创建 API 调用
    - 测试错误处理

- [x] 5. 扩展模拟 API 服务（mockApiService.ts）
  - [x] 5.1 添加品牌相关的模拟端点
    - 实现 GET /brands 端点（支持搜索和筛选）
    - 实现 GET /brands/:id 端点
    - 实现 POST /brands 端点（包含唯一性验证）
    - 实现 PUT /brands/:id 端点
    - 实现 DELETE /brands/:id 端点
    - 实现 POST /brands/batch 端点
    - 添加品牌数据的 localStorage 持久化
    - 生成初始测试品牌数据
    - _需求：8.2_

  - [ ]* 5.2 编写模拟 API 服务的单元测试
    - 测试所有端点的响应格式
    - 测试数据持久化功能
    - 测试搜索和筛选逻辑
    - 测试唯一性约束验证

- [x] 6. 检查点 - 确保服务层和 API 层测试通过
  - 运行所有测试：`npm test`
  - 确保所有服务层和 API 层的测试通过
  - 如有问题，请向用户询问

- [x] 7. 实现品牌 Store（brandStore.ts）
  - [x] 7.1 创建品牌 Pinia Store
    - 使用 Setup Store 语法定义 Store
    - 定义状态：brands, isLoading, loadingOperation, error, searchKeyword, filterStatus
    - 实现计算属性：filteredBrands, brandCount, hasBrands
    - 实现 fetchBrands 方法
    - 实现 getBrandById 方法
    - 实现 createBrand 方法
    - 实现 updateBrand 方法
    - 实现 deleteBrand 方法
    - 实现 batchImportBrands 方法
    - 实现 setSearchKeyword 方法
    - 实现 setFilterStatus 方法
    - 实现 clearError 方法
    - 实现 $reset 方法
    - _需求：1.1, 2.1, 2.4, 3.1, 4.1, 5.1, 5.2, 7.6, 8.1_

  - [ ]* 7.2 编写品牌 Store 的属性测试
    - **属性 6：成功操作反馈** - 验证需求 2.5, 2.6, 3.5, 3.6, 4.3, 4.4
    - **属性 10：删除操作移除品牌** - 验证需求 4.2
    - **属性 11：取消删除保持状态** - 验证需求 4.5
    - **属性 12：搜索关键词匹配** - 验证需求 5.1
    - **属性 13：状态筛选匹配** - 验证需求 5.2
    - **属性 14：组合筛选条件** - 验证需求 5.3
    - **属性 15：清空搜索恢复完整列表** - 验证需求 5.5
    - **属性 21：重复编码处理** - 验证需求 7.6
    - **属性 22：批量导入结果统计** - 验证需求 7.7
    - **属性 23：数据变化持久化** - 验证需求 8.1
    - **属性 24：API 失败状态保持** - 验证需求 8.4
    - **属性 25：加载状态生命周期** - 验证需求 9.1, 9.2

  - [ ]* 7.3 编写品牌 Store 的单元测试
    - 测试 Store 初始化状态
    - 测试 fetchBrands 方法
    - 测试 createBrand 方法
    - 测试 updateBrand 方法
    - 测试 deleteBrand 方法
    - 测试搜索和筛选功能
    - 测试错误处理

- [x] 8. 实现品牌表单组件（BrandForm.vue）
  - [x] 8.1 创建品牌表单组件
    - 使用 `<script setup lang="ts">` 语法
    - 定义 Props 接口（visible, brand, mode）
    - 定义 Emits 接口（update:visible, success）
    - 实现表单字段（品牌名称、品牌编码、品牌状态）
    - 实现表单验证规则
    - 实现表单提交逻辑（调用 brandStore 方法）
    - 实现表单重置逻辑
    - 使用 Ant Design Vue 的 Modal 和 Form 组件
    - _需求：2.1, 2.2, 2.3, 3.1, 3.2_

  - [ ]* 8.2 编写品牌表单组件的属性测试
    - **属性 7：失败操作反馈** - 验证需求 2.7
    - **属性 8：编辑表单预填充** - 验证需求 3.2
    - **属性 9：更新时的编码唯一性验证** - 验证需求 3.4
    - **属性 28：验证错误详情** - 验证需求 9.5

  - [ ]* 8.3 编写品牌表单组件的单元测试
    - 测试表单渲染
    - 测试创建模式的表单提交
    - 测试编辑模式的表单预填充
    - 测试表单验证
    - 测试错误处理

- [x] 9. 实现品牌管理主组件（BrandManagement.vue）
  - [x] 9.1 创建品牌管理主组件
    - 使用 `<script setup lang="ts">` 语法
    - 实现操作栏（新增、下载模板、批量导入按钮）
    - 集成 SearchFilter 组件
    - 实现品牌列表表格（使用 Ant Design Vue Table）
    - 实现表格列定义（品牌名称、编码、操作人、操作时间、状态、操作）
    - 实现状态列的自定义渲染（绿色/红色标签）
    - 实现操作列（编辑、删除按钮）
    - 实现分页功能
    - 集成 BrandForm 组件
    - 实现文件上传处理
    - 实现加载状态显示
    - 实现错误提示显示
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 3.1, 4.1, 5.1, 6.4, 7.1, 9.1, 9.2_

  - [ ]* 9.2 编写品牌管理主组件的属性测试
    - **属性 1：状态标签颜色映射** - 验证需求 1.4, 1.5
    - **属性 2：表格列完整性** - 验证需求 1.2
    - **属性 18：文件格式验证** - 验证需求 7.2, 7.3
    - **属性 26：网络错误提示** - 验证需求 9.3
    - **属性 27：服务器错误提示** - 验证需求 9.4

  - [ ]* 9.3 编写品牌管理主组件的单元测试
    - 测试组件渲染
    - 测试操作按钮点击
    - 测试表格数据显示
    - 测试状态标签渲染
    - 测试搜索和筛选交互
    - 测试文件上传
    - 测试加载状态显示

- [ ] 10. 集成测试和端到端测试
  - [ ]* 10.1 编写品牌管理的集成测试
    - 测试完整的品牌生命周期（创建 → 编辑 → 删除）
    - 测试搜索和筛选的端到端流程
    - 测试批量导入的完整流程
    - 测试错误处理的端到端流程
    - 测试数据持久化

  - [ ]* 10.2 编写组件交互的集成测试
    - 测试 BrandManagement 和 BrandForm 的交互
    - 测试 BrandManagement 和 SearchFilter 的交互
    - 测试 Store 和组件的数据流

- [x] 11. 添加路由配置（如果需要）
  - 在 `src/router/index.ts` 中添加品牌管理路由
  - 配置路由路径和组件映射
  - 添加路由守卫（如果需要权限控制）
  - _需求：1.1_

- [x] 12. 响应式设计优化
  - 为移动设备优化表格布局
  - 调整对话框在小屏幕上的显示
  - 测试不同屏幕尺寸下的显示效果
  - _需求：10.1, 10.2, 10.3, 10.4_

- [x] 13. 性能优化
  - 实现搜索防抖（300ms）
  - 实现请求取消机制
  - 优化大数据量的表格渲染
  - 添加数据缓存策略
  - _需求：5.1_

- [x] 14. 最终检查点 - 确保所有测试通过
  - 运行所有测试：`npm test`
  - 运行类型检查：`npm run type-check`
  - 运行代码检查：`npm run lint`
  - 检查测试覆盖率：`npm test -- --coverage`
  - 确保覆盖率达到目标（代码覆盖率 90%+，分支覆盖率 85%+）
  - 如有问题，请向用户询问

- [x] 15. 文档和代码审查
  - 确保所有代码都有中文注释
  - 确保所有函数都有 JSDoc 注释
  - 检查代码是否遵循项目规范
  - 更新 README.md（如果需要）

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 任务按照从底层到上层的顺序组织，确保依赖关系清晰
- 检查点任务确保增量验证，及时发现问题
- 所有属性测试必须使用 fast-check 库，最少 100 次迭代
- 所有属性测试必须在测试名称中包含"Property"关键字
- 所有属性测试必须引用设计文档中的正确性属性编号

## 实施建议

1. **按顺序执行任务**：从任务 1 开始，依次完成每个任务
2. **增量测试**：完成每个任务后立即运行相关测试
3. **及时沟通**：遇到问题时及时向用户询问
4. **代码审查**：定期检查代码质量和规范遵循情况
5. **文档更新**：及时更新代码注释和文档
