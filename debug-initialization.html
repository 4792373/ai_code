<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è°ƒè¯•åˆå§‹åŒ–æµç¨‹</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background-color: #1e1e1e;
      color: #d4d4d4;
    }
    h1 {
      color: #4ec9b0;
    }
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 14px;
      cursor: pointer;
      background-color: #0e639c;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #1177bb;
    }
    .danger {
      background-color: #f48771;
    }
    .danger:hover {
      background-color: #f14c4c;
    }
    pre {
      background-color: #252526;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      border-left: 3px solid #4ec9b0;
    }
    .log-entry {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #569cd6;
      padding-left: 10px;
    }
    .log-error {
      border-left-color: #f48771;
      color: #f48771;
    }
    .log-success {
      border-left-color: #4ec9b0;
      color: #4ec9b0;
    }
    .log-info {
      border-left-color: #569cd6;
      color: #569cd6;
    }
  </style>
</head>
<body>
  <h1>ğŸ” åˆå§‹åŒ–æµç¨‹è°ƒè¯•å·¥å…·</h1>
  
  <div>
    <button onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–æµç¨‹</button>
    <button onclick="checkLocalStorage()">æ£€æŸ¥ LocalStorage</button>
    <button class="danger" onclick="clearAndTest()">æ¸…ç©ºå¹¶é‡æ–°æµ‹è¯•</button>
  </div>

  <h2>æ—¥å¿—è¾“å‡ºï¼š</h2>
  <div id="logs"></div>

  <script type="module">
    import { getApiClient } from './src/services/apiClient.ts'
    import { getMockApiService, initializeMockApiService, cleanupMockApiService } from './src/services/mockApiService.ts'

    let logCount = 0

    function addLog(message, type = 'info') {
      const logsDiv = document.getElementById('logs')
      const logEntry = document.createElement('div')
      logEntry.className = `log-entry log-${type}`
      logEntry.textContent = `[${++logCount}] ${new Date().toLocaleTimeString()} - ${message}`
      logsDiv.appendChild(logEntry)
      logsDiv.scrollTop = logsDiv.scrollHeight
    }

    window.testInitialization = async function() {
      const logsDiv = document.getElementById('logs')
      logsDiv.innerHTML = ''
      logCount = 0

      try {
        addLog('å¼€å§‹æµ‹è¯•åˆå§‹åŒ–æµç¨‹...', 'info')
        
        // 1. æ£€æŸ¥ localStorage
        addLog('æ­¥éª¤ 1: æ£€æŸ¥ localStorage', 'info')
        const stored = localStorage.getItem('mock_api_users')
        if (stored) {
          const data = JSON.parse(stored)
          addLog(`  âœ“ æ‰¾åˆ°å·²å­˜å‚¨çš„æ•°æ®: ${data.users?.length || 0} ä¸ªç”¨æˆ·`, 'success')
        } else {
          addLog('  âœ“ localStorage ä¸ºç©º', 'success')
        }

        // 2. åˆå§‹åŒ– Mock API æœåŠ¡
        addLog('æ­¥éª¤ 2: åˆå§‹åŒ– Mock API æœåŠ¡', 'info')
        initializeMockApiService()
        const mockService = getMockApiService()
        addLog('  âœ“ Mock API æœåŠ¡å·²åˆå§‹åŒ–', 'success')

        // 3. è·å–ç”¨æˆ·åˆ—è¡¨
        addLog('æ­¥éª¤ 3: é€šè¿‡ Mock API è·å–ç”¨æˆ·åˆ—è¡¨', 'info')
        const response = await mockService.handleGetUsers()
        addLog(`  âœ“ è·å–åˆ° ${response.data.length} ä¸ªç”¨æˆ·`, 'success')

        // 4. é€šè¿‡ API å®¢æˆ·ç«¯è·å–ç”¨æˆ·åˆ—è¡¨
        addLog('æ­¥éª¤ 4: é€šè¿‡ API å®¢æˆ·ç«¯è·å–ç”¨æˆ·åˆ—è¡¨', 'info')
        const apiClient = getApiClient()
        const apiResponse = await apiClient.getUsers()
        addLog(`  âœ“ API å®¢æˆ·ç«¯è¿”å› ${apiResponse.data.length} ä¸ªç”¨æˆ·`, 'success')

        // 5. å†æ¬¡æ£€æŸ¥ localStorage
        addLog('æ­¥éª¤ 5: å†æ¬¡æ£€æŸ¥ localStorage', 'info')
        const storedAfter = localStorage.getItem('mock_api_users')
        if (storedAfter) {
          const dataAfter = JSON.parse(storedAfter)
          addLog(`  âœ“ å½“å‰å­˜å‚¨: ${dataAfter.users?.length || 0} ä¸ªç”¨æˆ·`, 'success')
        }

        addLog('âœ… æµ‹è¯•å®Œæˆï¼', 'success')

      } catch (error) {
        addLog(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error')
        console.error('æµ‹è¯•é”™è¯¯:', error)
      }
    }

    window.checkLocalStorage = function() {
      const logsDiv = document.getElementById('logs')
      logsDiv.innerHTML = ''
      logCount = 0

      addLog('æ£€æŸ¥ LocalStorage æ•°æ®...', 'info')
      
      const stored = localStorage.getItem('mock_api_users')
      if (stored) {
        try {
          const data = JSON.parse(stored)
          addLog(`æ‰¾åˆ° mock_api_users:`, 'success')
          addLog(`  - ç”¨æˆ·æ•°é‡: ${data.users?.length || 0}`, 'info')
          addLog(`  - æ—¶é—´æˆ³: ${data.timestamp}`, 'info')
          addLog(`  - ç‰ˆæœ¬: ${data.version}`, 'info')
          
          if (data.users && data.users.length > 0) {
            addLog(`å‰ 3 ä¸ªç”¨æˆ·:`, 'info')
            data.users.slice(0, 3).forEach((user, index) => {
              addLog(`  ${index + 1}. ${user.name} (${user.email})`, 'info')
            })
          }
        } catch (e) {
          addLog(`è§£æå¤±è´¥: ${e.message}`, 'error')
        }
      } else {
        addLog('æœªæ‰¾åˆ° mock_api_users æ•°æ®', 'info')
      }

      // æ˜¾ç¤ºæ‰€æœ‰ localStorage é”®
      addLog(`\nLocalStorage æ€»å…±æœ‰ ${localStorage.length} ä¸ªé”®`, 'info')
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i)
        addLog(`  - ${key}`, 'info')
      }
    }

    window.clearAndTest = async function() {
      if (!confirm('ç¡®å®šè¦æ¸…ç©º LocalStorage å¹¶é‡æ–°æµ‹è¯•å—ï¼Ÿ')) {
        return
      }

      const logsDiv = document.getElementById('logs')
      logsDiv.innerHTML = ''
      logCount = 0

      addLog('æ¸…ç©º LocalStorage...', 'info')
      localStorage.clear()
      addLog('âœ“ å·²æ¸…ç©º', 'success')

      addLog('æ¸…ç† Mock API æœåŠ¡...', 'info')
      cleanupMockApiService()
      addLog('âœ“ å·²æ¸…ç†', 'success')

      addLog('ç­‰å¾… 1 ç§’...', 'info')
      await new Promise(resolve => setTimeout(resolve, 1000))

      await window.testInitialization()
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.checkLocalStorage()
  </script>
</body>
</html>
